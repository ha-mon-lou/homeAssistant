- id: "ventilador_habitacion_auto"
  alias: Control ventilador habitacion por temperatura
  description: Ajusta la velocidad del ventilador habitacion según diferencia térmica
  trigger:
    - platform: state
      entity_id:
        - sensor.sensacion_termica_habitacion
        - input_select.ventilador_habitacion_modo_auto
        - input_number.ventilador_margen_calor
        - input_number.nivel_sensacion_termica_ideal
  condition:
    - condition: state
      entity_id: input_select.ventilador_habitacion_modo_auto
      state: "auto"
  action:
    - variables:
        dif_temp: >
          {{ (states('sensor.sensacion_termica_habitacion') | float + states('input_number.ventilador_margen_calor') | float) -
             states('input_number.nivel_sensacion_termica_ideal') | float }}
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ dif_temp <= 0.0 }}"
          sequence:
            - condition: template
              value_template: "{{ states('input_select.ventilador_habitacion_botonera') != 'Apagar' }}"
            - service: script.selector_ventilador
              data:
                dispositivo: ventilador_habitacion
                modo: auto
                valor: Apagar

        - conditions:
            - condition: template
              value_template: "{{ dif_temp > 0.0 and dif_temp <= 1.5 }}"
          sequence:
            - condition: template
              value_template: "{{ states('input_select.ventilador_habitacion_botonera') != 'velocidad 1' }}"
            - service: script.selector_ventilador
              data:
                dispositivo: ventilador_habitacion
                modo: auto
                valor: velocidad 1

        - conditions:
            - condition: template
              value_template: "{{ dif_temp > 1.5 and dif_temp <= 2.5 }}"
          sequence:
            - condition: template
              value_template: "{{ states('input_select.ventilador_habitacion_botonera') != 'velocidad 2' }}"
            - service: script.selector_ventilador
              data:
                dispositivo: ventilador_habitacion
                modo: auto
                valor: velocidad 2

        - conditions:
            - condition: template
              value_template: "{{ dif_temp > 2.5 and dif_temp <= 3.0 }}"
          sequence:
            - condition: template
              value_template: "{{ states('input_select.ventilador_habitacion_botonera') != 'velocidad 3' }}"
            - service: script.selector_ventilador
              data:
                dispositivo: ventilador_habitacion
                modo: auto
                valor: velocidad 3
        - conditions:
            - condition: template
              value_template: "{{ dif_temp > 3.0 }}"
          sequence:
            - condition: template
              value_template: "{{ states('input_select.ventilador_habitacion_botonera') != 'brisa' }}"
            - service: script.selector_ventilador
              data:
                dispositivo: ventilador_habitacion
                modo: auto
                valor: brisa
  mode: single
