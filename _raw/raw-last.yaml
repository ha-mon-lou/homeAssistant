decluttering_templates:
  ventilador_control:
    variables:
      - nombre
      - id
      - fondo: "#1e1e2f"
    card:
      type: custom:mod-card
      style:
        .: |
          ha-card {
            background: [[fondo]];
            padding: 12px;
            border-radius: 12px;
          }
      card:
        type: vertical-stack
        cards:
          - type: horizontal-stack
            cards:
              - type: button
                show_name: true
                show_icon: false
                show_state: true
                entity: input_boolean.ventilador_[[id]]
                name: "[[nombre]]"
              - type: custom:mushroom-entity-card
                entity: sensor.sensacion_termica_[[id]]
                name: Tuya
                icon_color: auto
                fill_container: true
                secondary_info: last-updated
                primary_info: state
                icon_type: icon
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_botonera
                show-name: false
                name: " "
                icon: mdi:fan-off
                tap_action:
                  action: call-service
                  service: script.selector_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    desde: boton-off
                    modo: manual
                    valor: Apagar
                state:
                  - value: Apagar
                    styles:
                      card:
                        - background-color: "#2e2e2e"
                      icon:
                        - color: "#f44336"
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_botonera
                show-name: false
                name: " "
                icon: mdi:fan-speed-1
                tap_action:
                  action: call-service
                  service: script.selector_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    desde: boton-v1
                    modo: manual
                    valor: velocidad 1
                state:
                  - value: velocidad 1
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_botonera
                show-name: false
                name: " "
                icon: mdi:fan-speed-2
                tap_action:
                  action: call-service
                  service: script.selector_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    desde: boton-v2
                    modo: manual
                    valor: velocidad 2
                state:
                  - value: velocidad 2
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_botonera
                show-name: false
                name: " "
                icon: mdi:fan-speed-3
                tap_action:
                  action: call-service
                  service: script.selector_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    desde: boton-v3
                    modo: manual
                    valor: velocidad 3
                state:
                  - value: velocidad 3
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
          - type: horizontal-stack
            cards:
              - type: button
                show_name: false
                show_icon: true
                show_state: true
                icon: mdi:sun-snowflake
                tap_action:
                  action: call-service
                  service: script.envia_comando_broadlink
                  data:
                    dispositivo: ventilador_[[id]]
                    comando: reverse
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_modo_auto
                name: " "
                show-name: false
                icon: mdi:fan-auto
                tap_action:
                  action: call-service
                  service: script.modo_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    valor: auto
                state:
                  - value: auto
                    styles:
                      card:
                        - background-color: "#2b5e90"
                      icon:
                        - color: "#FFFFFF"
              - type: custom:button-card
                entity: input_select.ventilador_[[id]]_botonera
                name: " "
                show-name: false
                icon: mdi:wind-power
                tap_action:
                  action: call-service
                  service: script.selector_ventilador
                  data:
                    dispositivo: ventilador_[[id]]
                    modo: manual
                    valor: brisa
                state:
                  - value: brisa
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                entity: timer.ventilador_[[id]]_file_timer
                show_name: false
                show_icon: false
                show_state: true
                styles:
                  card:
                    - width: 70px
                    - height: 48px
                    - text-align: center
                    - font-size: 14px
                    - padding: 4px
              - type: custom:button-card
                entity_id: input_select.ventilador_[[id]]_temporizador
                icon: mdi:numeric-1-circle
                tap_action:
                  action: call-service
                  service: input_select.select_option
                  data:
                    entity_id: input_select.ventilador_[[id]]_temporizador
                    option: t1
                state:
                  - value: t1
                    styles:
                      card:
                        - background-color: "#2e2e2e"
                      icon:
                        - color: "#f44336"
              - type: custom:button-card
                entity_id: input_select.ventilador_[[id]]_temporizador
                icon: mdi:numeric-2-circle
                tap_action:
                  action: call-service
                  service: input_select.select_option
                  data:
                    entity_id: input_select.ventilador_[[id]]_temporizador
                    option: t2
                state:
                  - value: t2
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
              - type: custom:button-card
                entity_id: input_select.ventilador_[[id]]_temporizador
                icon: mdi:numeric-4-circle
                tap_action:
                  action: call-service
                  service: input_select.select_option
                  data:
                    entity_id: input_select.ventilador_[[id]]_temporizador
                    option: t3
                state:
                  - value: t3
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
              - type: custom:button-card
                entity_id: input_select.ventilador_[[id]]_temporizador
                icon: mdi:numeric-8-circle
                tap_action:
                  action: call-service
                  service: input_select.select_option
                  data:
                    entity_id: input_select.ventilador_[[id]]_temporizador
                    option: t4
                state:
                  - value: t4
                    styles:
                      card:
                        - background-color: "#1b5e20"
                      icon:
                        - color: "#81c784"
views:
  - title: Termostato
    sections:
      - type: grid
        cards:
          - type: grid
            columns: 2
            square: false
            cards:
              - type: conditional
                conditions:
                  - entity: input_boolean.invierno
                    state: "on"
                card:
                  type: custom:mushroom-climate-card
                  entity: climate.zigbee_sonoff_trvzb_02
                  show_temperature_control: true
                  hvac_modes:
                    - auto
                    - heat
                    - "off"
                  collapsible_controls: false
                  tap_action:
                    action: more-info
                  grid_options:
                    columns: 6
                    rows: 2
                  hold_action:
                    action: toggle
              - type: conditional
                conditions:
                  - entity: input_boolean.invierno
                    state: "on"
                card:
                  type: custom:mushroom-climate-card
                  entity: climate.zigbee_sonoff_trvzb_03
                  show_temperature_control: true
                  hvac_modes:
                    - auto
                    - heat
                    - "off"
                  collapsible_controls: false
                  tap_action:
                    action: more-info
                  grid_options:
                    columns: 6
                    rows: 2
                  hold_action:
                    action: toggle
          - type: grid
            columns: 2
            square: false
            cards:
              - type: conditional
                conditions:
                  - entity: input_boolean.invierno
                    state: "on"
                card:
                  type: custom:mushroom-climate-card
                  entity: climate.zigbee_sonoff_trvzb_01
                  show_temperature_control: true
                  hvac_modes:
                    - auto
                    - heat
                    - "off"
                  collapsible_controls: false
                  tap_action:
                    action: more-info
                  grid_options:
                    columns: 6
                    rows: 2
                  hold_action:
                    action: toggle
              - type: conditional
                conditions:
                  - entity: input_boolean.invierno
                    state: "on"
                card:
                  type: custom:mushroom-climate-card
                  entity: climate.zigbee_sonoff_trvzb_04
                  show_temperature_control: true
                  hvac_modes:
                    - auto
                    - heat
                    - "off"
                  collapsible_controls: false
                  tap_action:
                    action: more-info
                  grid_options:
                    columns: 6
                    rows: 2
                  hold_action:
                    action: toggle
          - type: custom:mushroom-climate-card
            entity: climate.termostato_virtual
            show_temperature_control: true
            hvac_modes:
              - auto
              - heat
              - "off"
            collapsible_controls: false
            tap_action:
              action: more-info
            grid_options:
              columns: 12
              rows: 2
            hold_action:
              action: toggle
          - type: entity
            entity: sensor.zigbee_heiman_hs3aq_co2
            name: CO₂ Nivel
            icon: mdi:molecule-co2
            state_color: true
            card_mod:
              style: |
                ha-card {
                  text-align: center;
                }
                .value {
                  font-size: 32px;
                  font-weight: bold;
                  color: {% if states('sensor.zigbee_heiman_hs3aq_co2') | int < 800 %}
                    lightgreen
                  {% elif states('sensor.zigbee_heiman_hs3aq_co2') | int < 1500 %}
                    orange
                  {% elif states('sensor.zigbee_heiman_hs3aq_co2') | int < 2000 %}
                    red
                  {% else %}
                    purple
                  {% endif %};
                }
      - type: grid
        cards:
          - graph: line
            type: sensor
            detail: 2
            entity: sensor.temperatura_exterior
          - graph: line
            type: sensor
            detail: 1
            entity: sensor.humedad_exterior
          - graph: line
            type: sensor
            detail: 1
            entity: sensor.temperatura_interior
          - graph: line
            type: sensor
            detail: 2
            entity: sensor.humedad_interior
          - type: entities
            entities:
              - entity: input_boolean.invierno
              - entity: input_number.nivel_confort_actual
              - entity: input_button.send_confort
              - entity: sensor.flask_server
                name: T. predicción AI
                icon: mdi:air-filter
    type: sections
    max_columns: 4
    cards: []
    icon: mdi:home-thermometer
    badges:
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        color: ""
        entity: sensor.zigbee_heiman_hs3aq_co2
  - type: sections
    max_columns: 4
    title: Luces
    path: luces
    icon: mdi:floor-lamp
    sections:
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: switch.enchufe_habitacion_socket_1
              - entity: switch.enchufe_habitacion_socket_2
              - entity: switch.shelly1minig3_34b7dac6f3e4_switch_0
          - type: entities
            entities:
              - entity: switch.enchufe_doble_socket_1
              - entity: switch.enchufe_doble_socket_2
          - type: entities
            entities:
              - entity: input_button.shutdown
              - entity: input_button.studiobricks_toggle
  - type: sections
    max_columns: 4
    title: Rooms
    path: rooms
    sections:
      - type: grid
        cards:
          - type: custom:tabbed-card
            options:
              default_tab: Hoy
              title_field: name
            tabs:
              - attributes:
                  icon: mdi:microphone-settings
                card:
                  type: entities
                  title: studioBricks
                  state_color: true
                  show_header_toggle: true
                  entities:
                    - entity: switch.regleta_antela_socket_3
                      secondary_info: last-changed
                    - entity: switch.regleta_antela_socket_2
                      secondary_info: last-changed
                    - entity: switch.regleta_antela_socket_1
                      secondary_info: last-changed
                    - entity: switch.regleta_antela_socket_5
                      secondary_info: last-changed
                    - entity: input_button.studiobricks_toggle
                    - entity: sensor.regleta_antela_power
              - attributes:
                  icon: mdi:bed-double-outline
                card:
                  type: vertical-stack
                  cards:
                    - type: entities
                      title: Grande
                      state_color: true
                      show_header_toggle: true
                      entities:
                        - entity: sensor.zigbee_heiman_hs3aq_co2
                        - entity: sensor.zigbee_heiman_hs3aq_temperature
                          name: Temperatura Heiman
                        - entity: sensor.zigbee_heiman_hs3aq_humidity
                          name: Humedad Heiman
                        - entity: switch.shelly1minig3_34b7dac6f3e4_switch_0
                        - entity: sensor.zigbee_sonoff_trvzb_02_battery
                    - type: custom:mushroom-climate-card
                      entity: climate.zigbee_sonoff_trvzb_02
                      show_temperature_control: false
                      hvac_modes:
                        - auto
                        - heat
                        - "off"
                      collapsible_controls: true
                      tap_action:
                        action: more-info
                      hold_action:
                        action: toggle
                      grid_options:
                        columns: 6
                        rows: 2
              - attributes:
                  icon: mdi:bed-single-outline
                card:
                  type: entities
                  title: Pequeña
                  state_color: true
                  show_header_toggle: true
                  entities:
                    - entity: sensor.zigbee_sonoff_snzb02_01_temperature
                      name: Temperatura Sonoff
                    - entity: sensor.zigbee_sonoff_snzb02_01_humidity
                      name: Humedad Sonoff
              - attributes:
                  icon: mdi:desktop-classic
                card:
                  type: entities
                  title: Despacho
                  state_color: true
                  show_header_toggle: true
                  entities:
                    - entity: input_boolean.ventilador_despacho
                      name: Ventilador
                    - entity: sensor.tuya_termometro_wifi_temperature
                      name: Temperatura Tuya
                    - entity: sensor.tuya_termometro_wifi_humidity
                      name: Humedad Tuya
                    - entity: sensor.confort_termico_tuya_wifi_1
                    - entity: sensor.sensacion_termica_tuya_wifi_1
                    - entity: sensor.zigbee_sonoff_trvzb_03_battery
                    - type: custom:mushroom-climate-card
                      entity: climate.zigbee_sonoff_trvzb_03
                      show_temperature_control: false
                      hvac_modes:
                        - auto
                        - heat
                        - "off"
                      collapsible_controls: true
                      tap_action:
                        action: more-info
                      hold_action:
                        action: toggle
                      grid_options:
                        columns: 6
                        rows: 2
              - attributes:
                  icon: mdi:sofa-outline
                card:
                  type: entities
                  title: Living
                  state_color: true
                  show_header_toggle: true
                  entities:
                    - entity: sensor.temperatura_interior
                      name: Temperatura interior
                    - entity: sensor.humedad_interior
                      name: Humedad
                    - entity: sensor.confort_termico
                    - entity: sensor.sensacion_termica
                    - entity: sensor.zigbee_sonoff_trvzb_01_battery
                    - type: custom:mushroom-climate-card
                      entity: climate.zigbee_sonoff_trvzb_01
                      show_temperature_control: false
                      hvac_modes:
                        - auto
                        - heat
                        - "off"
                      collapsible_controls: true
                      tap_action:
                        action: more-info
                      hold_action:
                        action: toggle
                      grid_options:
                        columns: 6
                        rows: 2
                    - type: custom:mushroom-climate-card
                      entity: climate.zigbee_sonoff_trvzb_04
                      show_temperature_control: false
                      hvac_modes:
                        - auto
                        - heat
                        - "off"
                      collapsible_controls: true
                      tap_action:
                        action: more-info
                      hold_action:
                        action: toggle
                      grid_options:
                        columns: 6
                        rows: 2
              - attributes:
                  icon: mdi:knife-military
                card:
                  type: entities
                  title: Cocina
                  state_color: true
                  show_header_toggle: true
                  entities:
                    - entity: switch.alias_frigorifico
                      secondary_info: last-changed
                    - entity: switch.alias_lavavajillas
                      secondary_info: last-changed
    icon: mdi:home
    cards: []
  - type: sections
    max_columns: 4
    title: Ventiladores
    path: control-ventiladores
    icon: mdi:fan
    sections:
      - type: grid
        cards:
          - type: custom:decluttering-card
            template: ventilador_control
            variables:
              - nombre: Habitacion
              - id: habitacion
              - fondo: "#001e00"
          - type: custom:decluttering-card
            template: ventilador_control
            variables:
              - nombre: Despacho
              - id: despacho
    badges:
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        entity: sensor.temperatura_exterior
  - type: sections
    max_columns: 4
    title: switch
    path: switch
    icon: mdi:toggle-switch
    sections:
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: switch.zigbee_nous_enchufe_01
                secondary_info: last-changed
              - entity: switch.alias_frigorifico
                secondary_info: last-changed
              - entity: switch.alias_lavavajillas
                secondary_info: last-changed
              - entity: switch.zigbee_nous_enchufe_04
                secondary_info: last-changed
            state_color: false
            show_header_toggle: true
            title: Enchufes
  - type: sections
    max_columns: 4
    title: temporizador
    path: temporizador
    icon: mdi:home-clock-outline
    sections:
      - type: grid
        cards:
          - type: custom:clock-weather-card
            entity: weather.st_quirze_del_v_vallsuau_barcelona
          - type: entities
            entities:
              - entity: timer.custom_temporizador1
              - entity: input_number.custom_temporizador1_mm
              - entity: input_button.custom_temporizador1_toggle
          - type: entities
            entities:
              - entity: timer.custom_temporizador2
              - entity: input_number.custom_temporizador2_mm
              - entity: input_button.custom_temporizador2_toggle
  - type: sections
    max_columns: 4
    title: baterias
    path: baterias
    icon: mdi:battery-unknown
    sections:
      - type: grid
        cards:
          - type: custom:battery-state-card
  - type: sections
    max_columns: 4
    title: Termostatos
    path: termostatos
    icon: mdi:temperature-celsius
    sections:
      - type: grid
        cards:
          - type: thermostat
            entity: climate.zigbee_sonoff_trvzb_01
            show_current_as_primary: true
            features:
              - type: climate-hvac-modes
      - type: grid
        cards:
          - type: thermostat
            entity: climate.zigbee_sonoff_trvzb_04
            show_current_as_primary: true
            features:
              - type: climate-hvac-modes
          - type: thermostat
            entity: climate.termostato_virtual
            features:
              - type: climate-hvac-modes
            show_current_as_primary: true
      - type: grid
        cards:
          - type: thermostat
            entity: climate.zigbee_sonoff_trvzb_03
            show_current_as_primary: true
            features:
              - type: climate-hvac-modes
      - type: grid
        cards:
          - type: thermostat
            entity: climate.zigbee_sonoff_trvzb_02
            show_current_as_primary: true
            features:
              - type: climate-hvac-modes
          - type: entities
            entities:
              - entity: climate.termostato_virtual
              - entity: sensor.temperatura_objetivo_max
              - entity: sensor.temperatura_objetivo_minima
              - entity: sensor.demanda_calefaccion
              - entity: sensor.temperatura_real_max
              - entity: sensor.temperatura_real_min
              - entity: sensor.temperatura_caldera
              - entity: sensor.temperatura_interior
          - type: entity
            entity: sensor.zigbee_heiman_hs3aq_co2
            name: CO₂ Nivel
            icon: mdi:molecule-co2
            state_color: true
            card_mod:
              style: |
                ha-card {
                  text-align: center;
                }
                .value {
                  font-size: 32px;
                  font-weight: bold;
                  color: {% if states('sensor.zigbee_heiman_hs3aq_co2') | int < 800 %}
                    lightgreen
                  {% elif states('sensor.zigbee_heiman_hs3aq_co2') | int < 1000 %}
                    orange
                  {% elif states('sensor.zigbee_heiman_hs3aq_co2') | int < 1500 %}
                    red
                  {% else %}
                    purple
                  {% endif %};
                }
    badges:
      - type: entity
        show_name: false
        show_state: true
        show_icon: true
        color: ""
        entity: climate.termostato_virtual
  - type: sections
    path: omie
    max_columns: 4
    title: OMIE
    icon: mdi:lightning-bolt
    sections:
      - type: grid
        cards:
          - type: custom:apexcharts-card
            header:
              show: true
              title: Precio OMIE por hora
              show_states: false
            graph_span: 2d
            span:
              start: day
            now:
              show: true
            yaxis:
              - decimals: 2
                min: -10
                max: 50
            series:
              - entity: sensor.omie_spot_price_es
                name: Precio Hoy
                type: column
                data_generator: |
                  let data = entity.attributes["today_hours"];
                  return Object.keys(data).map((key) => {
                    return [new Date(key).getTime(), data[key]];
                  });
                color: "#008FFB"
              - entity: sensor.omie_spot_price_es
                name: Precio Mañana
                type: column
                data_generator: |
                  let data = entity.attributes["tomorrow_hours"];
                  return Object.keys(data).map((key) => {
                    return [new Date(key).getTime(), data[key]];
                  });
                color: "#00E396"
